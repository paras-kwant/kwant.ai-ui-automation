name: Run Cypress UI Tests (Parallel)

on:
  workflow_dispatch:
  # schedule:
  #   - cron: "10 04 * * *" # 10:10 AM Nepal Time

jobs:
  companies-tests:
    name: üè¢ Companies UI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            ~/.cache/Cypress
            node_modules
          key: ${{ runner.os }}-cypress-${{ hashFiles('**/package-lock.json') }}

      - run: npm ci
      - run: npx cypress verify

      - run: rm -rf allure-results && mkdir -p allure-results

      - name: Run Companies Tests
        run: |
          npx cypress run \
            --spec "cypress/e2e/companies/**/*.cy.js" \
            --env email=$EMAIL,password=$PASSWORD \
            --browser chrome \
            --headless || true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: companies-allure-results
          path: allure-results

  workers-tests:
    name: üë∑ Workers UI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm ci
      - run: npx cypress verify
      - run: rm -rf allure-results && mkdir -p allure-results

      - name: Run Workers Tests
        run: |
          npx cypress run \
            --spec "cypress/e2e/workers/**/*.cy.js" \
            --env email=$EMAIL,password=$PASSWORD \
            --browser chrome \
            --headless || true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: workers-allure-results
          path: allure-results

  merge-reports:
    name: üìä Merge Allure Reports & Deploy
    needs: [companies-tests, workers-tests]
    runs-on: ubuntu-latest
    if: always()
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm install -g allure-commandline

      - uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: companies-allure-results
          path: merged-results/companies

      - uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: workers-allure-results
          path: merged-results/workers

      - name: Merge Results
        run: |
          mkdir -p merged-results/allure-results
          cp -rv merged-results/companies/* merged-results/allure-results/ || true
          cp -rv merged-results/workers/* merged-results/allure-results/ || true

      - name: Generate Allure Report (SAFE)
        run: |
          rm -rf allure-report
          mkdir -p allure-report

          if [ -d "merged-results/allure-results" ] && [ "$(ls -A merged-results/allure-results)" ]; then
            allure generate merged-results/allure-results --clean -o allure-report
          else
            echo "<h1>No test results generated</h1>" > allure-report/index.html
          fi

      - name: Extract Allure Summary (SAFE)
        id: summary
        run: |
          SUMMARY="allure-report/widgets/summary.json"

          if [ ! -f "$SUMMARY" ]; then
            echo "total=0" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "broken=0" >> $GITHUB_OUTPUT
            echo "skipped=0" >> $GITHUB_OUTPUT
            echo "success_rate=0.00" >> $GITHUB_OUTPUT
            echo "total_time=0m 0s" >> $GITHUB_OUTPUT
            echo "timestamp=$(date -u)" >> $GITHUB_OUTPUT
            exit 0
          fi

          TOTAL=$(jq '.statistic.total' $SUMMARY)
          PASSED=$(jq '.statistic.passed' $SUMMARY)
          FAILED=$(jq '.statistic.failed' $SUMMARY)
          BROKEN=$(jq '.statistic.broken' $SUMMARY)
          SKIPPED=$(jq '.statistic.skipped' $SUMMARY)
          DURATION=$(jq '.time.duration' $SUMMARY)

          RATE=$(awk "BEGIN {printf \"%.2f\", ($PASSED/$TOTAL)*100}")

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "broken=$BROKEN" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "success_rate=$RATE" >> $GITHUB_OUTPUT
          echo "total_time=$((DURATION/60000))m" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u)" >> $GITHUB_OUTPUT

      - name: üåç Deploy to Surge
        if: always()
        id: surge_deploy
        run: |
          npm install --global surge
          SURGE_URL="https://kwant-ui-automation.surge.sh"
          surge ./allure-report $SURGE_URL --token $SURGE_TOKEN
          echo "preview_url=$SURGE_URL" >> $GITHUB_OUTPUT

      - name: üí¨ Slack Notification
        if: always()
        run: |
          curl -X POST -H "Content-type: application/json" \
          --data "{\"text\":\"Allure Report: ${{ steps.surge_deploy.outputs.preview_url }}\"}" \
          "$SLACK_WEBHOOK_URL"
