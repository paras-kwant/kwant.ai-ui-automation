name: Run Cypress UI Tests (Parallel)

on:
  workflow_dispatch:
  schedule:
    - cron: "05 04 * * *" # 10:05 AM Nepal Time

jobs:
  companies-tests:
    name: üè¢ Companies UI Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Run Companies Cypress Tests
        run: |
          npx cypress run \
            --spec "cypress/e2e/companies/**/*.cy.js" \
            || true

      - name: Upload Companies Allure Results
        uses: actions/upload-artifact@v4
        with:
          name: companies-allure-results
          path: allure-results

  workers-tests:
    name: üë∑ Workers UI Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Run Workers Cypress Tests
        run: |
          npx cypress run \
            --spec "cypress/e2e/workers/**/*.cy.js" \
            || true

      - name: Upload Workers Allure Results
        uses: actions/upload-artifact@v4
        with:
          name: workers-allure-results
          path: allure-results

  merge-reports:
    name: üìä Merge Allure Reports & Notify
    needs: [companies-tests, workers-tests]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Allure CLI
        run: npm install -g allure-commandline

      - name: Download Companies Results
        uses: actions/download-artifact@v4
        with:
          name: companies-allure-results
          path: merged-results/companies

      - name: Download Workers Results
        uses: actions/download-artifact@v4
        with:
          name: workers-allure-results
          path: merged-results/workers

      - name: Merge Allure Results
        run: |
          mkdir -p merged-results/allure-results
          cp -r merged-results/companies/* merged-results/allure-results/ || true
          cp -r merged-results/workers/* merged-results/allure-results/ || true

      - name: Generate Allure Report
        run: |
          allure generate merged-results/allure-results \
            --clean \
            -o allure-report

      - name: Extract Allure Summary
        id: summary
        run: |
          SUMMARY="allure-report/widgets/summary.json"

          echo "total=$(jq '.statistic.total' $SUMMARY)" >> $GITHUB_OUTPUT
          echo "passed=$(jq '.statistic.passed' $SUMMARY)" >> $GITHUB_OUTPUT
          echo "failed=$(jq '.statistic.failed' $SUMMARY)" >> $GITHUB_OUTPUT
          echo "broken=$(jq '.statistic.broken' $SUMMARY)" >> $GITHUB_OUTPUT
          echo "skipped=$(jq '.statistic.skipped' $SUMMARY)" >> $GITHUB_OUTPUT
          echo "duration=$(jq '.time.duration' $SUMMARY)" >> $GITHUB_OUTPUT

      - name: Send Slack Notification (Combined)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"üß™ *UI Automation Test Summary (Combined)*\n
            *Total Tests:* ${{ steps.summary.outputs.total }}\n
            ‚úÖ *Passed:* ${{ steps.summary.outputs.passed }}\n
            ‚ùå *Failed:* ${{ steps.summary.outputs.failed }}\n
            üü† *Broken:* ${{ steps.summary.outputs.broken }}\n
            ‚è≠Ô∏è *Skipped:* ${{ steps.summary.outputs.skipped }}\n
            ‚è±Ô∏è *Duration:* ${{ steps.summary.outputs.duration }} ms\"
          }" \
          $SLACK_WEBHOOK_URL

      - name: Upload Final Allure Report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report
