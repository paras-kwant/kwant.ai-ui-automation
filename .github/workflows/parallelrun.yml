name: Run Cypress UI Tests (Parallel)

on:
  workflow_dispatch:
  # schedule:
    # - cron: "05 04 * * *"

jobs:
  companies-tests:
    name: üè¢ Companies UI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
      TWILIO_NUMBER: ${{ secrets.TWILIO_NUMBER }}
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
      EXPECTED_FROM: ${{ secrets.EXPECTED_FROM }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run Companies Cypress Tests
        run: |
          rm -rf allure-results && mkdir -p allure-results
          npx cypress run \
            --spec "cypress/e2e/companies/**/*.cy.js" \
            --env email=$EMAIL,password=$PASSWORD,TWILIO_NUMBER=$TWILIO_NUMBER,TWILIO_ACCOUNT_SID=$TWILIO_ACCOUNT_SID,TWILIO_AUTH_TOKEN=$TWILIO_AUTH_TOKEN,EXPECTED_FROM=$EXPECTED_FROM \
            --browser chrome --headless || true

      - name: Upload Companies Allure Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: companies-allure-results
          path: allure-results

  workers-tests:
    name: üë∑ Workers UI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
      TWILIO_NUMBER: ${{ secrets.TWILIO_NUMBER }}
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
      EXPECTED_FROM: ${{ secrets.EXPECTED_FROM }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run Workers Cypress Tests
        run: |
          rm -rf allure-results && mkdir -p allure-results
          npx cypress run \
            --spec "cypress/e2e/workers/**/*.cy.js" \
            --env email=$EMAIL,password=$PASSWORD,TWILIO_NUMBER=$TWILIO_NUMBER,TWILIO_ACCOUNT_SID=$TWILIO_ACCOUNT_SID,TWILIO_AUTH_TOKEN=$TWILIO_AUTH_TOKEN,EXPECTED_FROM=$EXPECTED_FROM \
            --browser chrome --headless || true

      - name: Upload Workers Allure Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: workers-allure-results
          path: allure-results

  insights-companies-tests:
    name: üìä Insights/Companies UI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
      TWILIO_NUMBER: ${{ secrets.TWILIO_NUMBER }}
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
      EXPECTED_FROM: ${{ secrets.EXPECTED_FROM }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run Insights/Companies Cypress Tests
        run: |
          rm -rf allure-results && mkdir -p allure-results
          npx cypress run \
            --spec "cypress/e2e/insights/companies/**/*.cy.js" \
            --env email=$EMAIL,password=$PASSWORD,TWILIO_NUMBER=$TWILIO_NUMBER,TWILIO_ACCOUNT_SID=$TWILIO_ACCOUNT_SID,TWILIO_AUTH_TOKEN=$TWILIO_AUTH_TOKEN,EXPECTED_FROM=$EXPECTED_FROM \
            --browser chrome --headless || true

      - name: Upload Insights/Companies Allure Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: insights-companies-allure-results
          path: allure-results

  merge-reports:
    name: üìä Merge Allure Reports & Deploy
    needs: [companies-tests, workers-tests, insights-companies-tests]
    runs-on: ubuntu-latest
    if: always()
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Allure CLI
        run: |
          npm install -g allure-commandline

      - name: Download Companies Results
        uses: actions/download-artifact@v4
        with:
          name: companies-allure-results
          path: merged-results/companies

      - name: Download Workers Results
        uses: actions/download-artifact@v4
        with:
          name: workers-allure-results
          path: merged-results/workers

      - name: Download Insights/Companies Results
        uses: actions/download-artifact@v4
        with:
          name: insights-companies-allure-results
          path: merged-results/insights-companies

      - name: Merge Allure Results
        run: |
          mkdir -p merged-results/allure-results
          cp -rv merged-results/companies/* merged-results/allure-results/ || true
          cp -rv merged-results/workers/* merged-results/allure-results/ || true
          cp -rv merged-results/insights-companies/* merged-results/allure-results/ || true

      - name: Generate Allure Report
        run: |
          rm -rf allure-report
          mkdir -p allure-report
          allure generate merged-results/allure-results --clean -o allure-report
          echo "‚úÖ Allure report generated with $(find allure-report -type f | wc -l) files"

      - name: Deploy Allure Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: Extract Allure Summary
        id: summary
        run: |
          SUMMARY="allure-report/widgets/summary.json"
          TOTAL=$(jq '.statistic.total' $SUMMARY)
          PASSED=$(jq '.statistic.passed' $SUMMARY)
          FAILED=$(jq '.statistic.failed' $SUMMARY)
          BROKEN=$(jq '.statistic.broken' $SUMMARY)
          SKIPPED=$(jq '.statistic.skipped' $SUMMARY)
          DURATION_MS=$(jq '.time.duration' $SUMMARY)
          SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($PASSED/$TOTAL)*100}")
          MINUTES=$((DURATION_MS / 60000))
          SECONDS=$(((DURATION_MS % 60000) / 1000))
          TOTAL_TIME="${MINUTES}m ${SECONDS}s"
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "broken=$BROKEN" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "total_time=$TOTAL_TIME" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      - name: üí¨ Send Slack Notification
        if: always()
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          PREVIEW_URL="https://${{ github.repository_owner }}.github.io/${REPO_NAME}/"
          TOTAL="${{ steps.summary.outputs.total }}"
          PASSED="${{ steps.summary.outputs.passed }}"
          FAILED="${{ steps.summary.outputs.failed }}"
          BROKEN="${{ steps.summary.outputs.broken }}"
          SKIPPED="${{ steps.summary.outputs.skipped }}"
          SUCCESS_RATE="${{ steps.summary.outputs.success_rate }}"
          TOTAL_TIME="${{ steps.summary.outputs.total_time }}"
          TIMESTAMP="${{ steps.summary.outputs.timestamp }}"

          TOTAL_FAILURES=$((FAILED + BROKEN))
          if [[ "$TOTAL" -eq 0 ]]; then
            STATUS="‚ö†Ô∏è Parallel UI tests did not run properly"
            COLOR="warning"
          elif [[ "$TOTAL_FAILURES" -eq 0 ]]; then
            STATUS="‚úÖ Parallel UI tests completed successfully"
            COLOR="good"
          elif [[ "$TOTAL_FAILURES" -eq 1 ]]; then
            STATUS="üö® $TOTAL_FAILURES test failed out of $TOTAL tests (Parallel)"
            COLOR="danger"
          else
            STATUS="üö® $TOTAL_FAILURES tests failed out of $TOTAL tests (Parallel)"
            COLOR="danger"
          fi

          PAYLOAD=$(jq -n \
            --arg color "$COLOR" \
            --arg status "$STATUS" \
            --arg total "$TOTAL" \
            --arg passed "$PASSED" \
            --arg failed "$FAILED" \
            --arg broken "$BROKEN" \
            --arg skipped "$SKIPPED" \
            --arg success_rate "$SUCCESS_RATE%" \
            --arg total_time "$TOTAL_TIME" \
            --arg timestamp "$TIMESTAMP" \
            --arg preview_url "$PREVIEW_URL" \
            '{
              attachments: [
                {
                  color: $color,
                  title: $status,
                  fields: [
                    {title: "Total Tests", value: $total, short: true},
                    {title: "‚úÖ Passed", value: $passed, short: true},
                    {title: "‚ùå Failed", value: $failed, short: true},
                    {title: "üü† Broken", value: $broken, short: true},
                    {title: "‚è≠Ô∏è Skipped", value: $skipped, short: true},
                    {title: "üìà Success Rate", value: $success_rate, short: true},
                    {title: "‚è±Ô∏è Duration", value: $total_time, short: true},
                    {title: "üïê Last Checked", value: $timestamp, short: false}
                  ],
                  actions: [
                    {type: "button", text: "View Report", url: $preview_url}
                  ]
                }
              ]
            }')

          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL"