name: Run Cypress UI Tests (Parallel Folders)

on:
  workflow_dispatch:
  schedule:
    - cron: "05 04 * * *" # Nepali 10:05 AM

jobs:
  cypress-run:
    name: Cypress - ${{ matrix.folder }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        folder:
          - companies
          - workers

    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests
        continue-on-error: true
        run: |
          mkdir -p cypress/results
          npx cypress run \
            --spec "cypress/e2e/${{ matrix.folder }}/**/*.cy.js" \
            --browser chrome \
            --headless \
            --reporter mochawesome \
            --reporter-options reportDir=cypress/results,overwrite=false,html=false,json=true

      - name: Merge module report
        run: |
          MODULE=${{ matrix.folder }}
          npx mochawesome-merge "cypress/results/*.json" \
            > cypress/results/merged-${MODULE}.json

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.folder }}
          path: cypress/results/merged-${{ matrix.folder }}.json
          retention-days: 7

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-${{ matrix.folder }}
          path: allure-results
          if-no-files-found: ignore
          retention-days: 7

  report:
    name: Aggregate Reports & Notify
    needs: cypress-run
    runs-on: ubuntu-latest
    if: always()

    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Download test reports
        uses: actions/download-artifact@v4
        with:
          path: all-results
          pattern: results-*

      - name: Download Allure results
        uses: actions/download-artifact@v4
        with:
          path: all-allure
          pattern: allure-*

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install tools
        run: npm install -g mochawesome-merge allure-commandline jq surge

      - name: Merge all reports
        id: aggregate
        run: |
          mkdir -p cypress/results
          find all-results -name "*.json" -exec cp {} cypress/results/ \;

          FILE_COUNT=$(ls cypress/results/*.json 2>/dev/null | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âŒ No reports found"
            exit 1
          fi

          npx mochawesome-merge "cypress/results/*.json" \
            > cypress/results/final-report.json

          TOTAL=$(jq '.stats.tests' cypress/results/final-report.json)
          PASSED=$(jq '.stats.passes' cypress/results/final-report.json)
          FAILED=$(jq '.stats.failures' cypress/results/final-report.json)
          SKIPPED=$(jq '.stats.pending' cypress/results/final-report.json)
          DURATION=$(jq '.stats.duration' cypress/results/final-report.json)

          SUCCESS=$(awk "BEGIN {printf \"%.2f\", ($PASSED/$TOTAL)*100}")

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT

      - name: Generate Allure Report
        run: |
          mkdir -p allure-results
          find all-allure -type f -exec cp {} allure-results/ \;
          allure generate allure-results --clean -o allure-report

      - name: Deploy to Surge
        id: surge
        run: |
          surge ./allure-report https://kwant-ui-automation.surge.sh --token $SURGE_TOKEN
          echo "url=https://kwant-ui-automation.surge.sh" >> $GITHUB_OUTPUT

      - name: Send Slack Notification
        run: |
          TOTAL=${{ steps.aggregate.outputs.total }}
          PASSED=${{ steps.aggregate.outputs.passed }}
          FAILED=${{ steps.aggregate.outputs.failed }}
          SUCCESS=${{ steps.aggregate.outputs.success_rate }}
          URL=${{ steps.surge.outputs.url }}

          if [ "$FAILED" -gt 0 ]; then
            STATUS="ðŸš¨ $FAILED test(s) failed out of $TOTAL"
            COLOR="danger"
          else
            STATUS="âœ… All $TOTAL UI tests passed"
            COLOR="good"
          fi

          jq -n \
            --arg color "$COLOR" \
            --arg status "$STATUS" \
            --arg total "$TOTAL" \
            --arg passed "$PASSED" \
            --arg failed "$FAILED" \
            --arg success "$SUCCESS%" \
            --arg url "$URL" \
            '{
              attachments: [
                {
                  color: $color,
                  title: $status,
                  fields: [
                    {title: "Total", value: $total, short: true},
                    {title: "Passed", value: $passed, short: true},
                    {title: "Failed", value: $failed, short: true},
                    {title: "Success Rate", value: $success, short: true}
                  ],
                  actions: [
                    {type: "button", text: "View Report", url: $url}
                  ]
                }
              ]
            }' | curl -X POST -H 'Content-type: application/json' \
              --data @- "$SLACK_WEBHOOK_URL"
