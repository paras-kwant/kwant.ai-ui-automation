name: Run Cypress UI Tests (Parallel Folders)

on:
  workflow_dispatch:
  schedule:
    - cron: "05 04 * * *" # Nepali 10:05 AM

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
      TWILIO_NUMBER: ${{ secrets.TWILIO_NUMBER }}
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
      EXPECTED_FROM: ${{ secrets.EXPECTED_FROM }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            ~/.cache/Cypress
            node_modules
          key: ${{ runner.os }}-cypress-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-cypress-

      - name: Install dependencies
        run: npm ci

      - name: Verify Cypress
        run: npx cypress verify

      # -----------------------------
      # Run Cypress Tests per folder
      # -----------------------------
      - name: Run Cypress - Companies & Workers
        run: |
          FOLDERS=("cypress/e2e/companies" "cypress/e2e/workers")
          rm -rf cypress/results/* allure-results/* allure-report/*
          mkdir -p cypress/results allure-results allure-report

          for FOLDER in "${FOLDERS[@]}"; do
            echo "=== Running all tests in $FOLDER ==="
            npx cypress run \
              --spec "$FOLDER/**/*.cy.js" \
              --browser chrome \
              --headless \
              --env email=$EMAIL,password=$PASSWORD \
              --reporter mochawesome \
              --reporter-options reportDir=cypress/results,overwrite=false,html=false,json=true \
              || true
          done

          # Merge all mochawesome JSON reports
          npx mochawesome-merge cypress/results/*.json > cypress/results/merged-report.json

          # Extract stats
          TOTAL=$(jq '.stats.tests' cypress/results/merged-report.json)
          PASSED=$(jq '.stats.passes' cypress/results/merged-report.json)
          FAILED=$(jq '.stats.failures' cypress/results/merged-report.json)
          SKIPPED=$(jq '.stats.pending' cypress/results/merged-report.json)
          TOTAL_TIME_MS=$(jq '.stats.duration' cypress/results/merged-report.json)

          # Calculate success rate
          if [ "$TOTAL" -gt 0 ]; then
            SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($PASSED/$TOTAL)*100}")
          else
            SUCCESS_RATE="0.00"
          fi

          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          MINUTES=$((TOTAL_TIME_MS / 60000))
          SECONDS=$(((TOTAL_TIME_MS % 60000) / 1000))
          TOTAL_TIME="${MINUTES}m ${SECONDS}s"

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "total_time=$TOTAL_TIME" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      # -----------------------------
      # Generate and Deploy Allure
      # -----------------------------
      - name: üåç Deploy Allure Report to Surge
        run: |
          npm install --global allure surge
          rm -rf allure-report
          allure generate allure-results --clean -o allure-report

          if [ -d "allure-report" ]; then
            SURGE_URL="kwant-ui-automation.surge.sh"
            surge allure-report $SURGE_URL --token $SURGE_TOKEN
            echo "preview_url=https://$SURGE_URL" >> $GITHUB_OUTPUT
          else
            echo "‚ùå allure-report folder not found!"
            echo "preview_url=https://kwant-ui-automation.surge.sh" >> $GITHUB_OUTPUT
          fi

      # -----------------------------
      # Slack Notification
      # -----------------------------
      - name: üí¨ Send Slack Notification
        if: always()
        run: |
          TOTAL="${{ steps.cypress-run.outputs.total }}"
          PASSED="${{ steps.cypress-run.outputs.passed }}"
          FAILED="${{ steps.cypress-run.outputs.failed }}"
          SKIPPED="${{ steps.cypress-run.outputs.skipped }}"
          SUCCESS_RATE="${{ steps.cypress-run.outputs.success_rate }}"
          TOTAL_TIME="${{ steps.cypress-run.outputs.total_time }}"
          TIMESTAMP="${{ steps.cypress-run.outputs.timestamp }}"
          PREVIEW_URL="${{ steps.surge_deploy.outputs.preview_url }}"

          # Determine status and color
          if [[ "$TOTAL" -eq 0 ]]; then
            STATUS="‚ö†Ô∏è UI tests did not run properly"
            COLOR="warning"
          elif [[ "$FAILED" -eq 0 ]]; then
            STATUS="‚úÖ UI tests completed successfully"
            COLOR="good"
          else
            STATUS="üö® $FAILED tests failed out of $TOTAL tests in UI"
            COLOR="danger"
          fi

          PAYLOAD=$(jq -n \
            --arg color "$COLOR" \
            --arg status "$STATUS" \
            --arg total "$TOTAL" \
            --arg passed "$PASSED" \
            --arg failed "$FAILED" \
            --arg skipped "$SKIPPED" \
            --arg success_rate "$SUCCESS_RATE%" \
            --arg total_time "$TOTAL_TIME" \
            --arg timestamp "$TIMESTAMP" \
            --arg preview_url "$PREVIEW_URL" \
            '{
              attachments: [
                {
                  color: $color,
                  title: $status,
                  fields: [
                    {title: "Total Tests", value: $total, short: true},
                    {title: "‚úÖ Passed", value: $passed, short: true},
                    {title: "‚ùå Failed", value: $failed, short: true},
                    {title: "‚è≠Ô∏è Skipped", value: $skipped, short: true},
                    {title: "üìà Success Rate", value: $success_rate, short: true},
                    {title: "‚è±Ô∏è Duration", value: $total_time, short: true},
                    {title: "üïê Last Checked", value: $timestamp, short: false}
                  ],
                  actions: [
                    {
                      type: "button",
                      text: "View Detailed Report",
                      url: $preview_url
                    }
                  ]
                }
              ]
            }')

          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URLs"
