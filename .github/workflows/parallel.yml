name: Run Cypress UI Tests (Parallel Folders) - Clean Approach

on:
  workflow_dispatch:
  schedule:
    - cron: "05 04 * * *" # Nepali 10:05 AM

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        folder: [companies, workers]  # run each folder in parallel
    timeout-minutes: 30
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
      TWILIO_NUMBER: ${{ secrets.TWILIO_NUMBER }}
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
      EXPECTED_FROM: ${{ secrets.EXPECTED_FROM }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            ~/.cache/Cypress
            node_modules
          key: ${{ runner.os }}-cypress-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-cypress-

      - name: Install dependencies
        run: npm ci

      - name: Verify Cypress
        run: npx cypress verify

      - name: Run Cypress tests for ${{ matrix.folder }}
        id: cypress
        continue-on-error: true
        run: |
          echo "=== Running all tests in cypress/e2e/${{ matrix.folder }} ==="
          
          # Clean everything first!
          rm -rf cypress/results allure-results allure-report
          mkdir -p cypress/results allure-results

          # Run Cypress
          npx cypress run \
            --spec "cypress/e2e/${{ matrix.folder }}/**/*.cy.js" \
            --env email=$EMAIL,password=$PASSWORD \
            --browser chrome \
            --headless \
            --reporter mochawesome \
            --reporter-options reportDir=cypress/results,overwrite=false,html=false,json=true \
            || true

          # Copy mochawesome results to allure-results
          cp -r cypress/results/* allure-results/ 2>/dev/null || echo "No results to copy"

          # Output folder name for artifact
          echo "folder_name=${{ matrix.folder }}" >> $GITHUB_OUTPUT

      - name: Generate Allure Report for ${{ matrix.folder }}
        run: |
          echo "üìä Generating Allure report for ${{ matrix.folder }}..."
          npm install -g allure-commandline --save-dev
          
          # Generate the report
          allure generate allure-results --clean -o allure-report
          
          echo "‚úÖ Allure report for ${{ matrix.folder }} generated"

      - name: Upload Allure Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.cypress.outputs.folder_name }}-report
          path: allure-report
          if-no-files-found: warn

  merge-and-deploy:
    runs-on: ubuntu-latest
    needs: cypress-run
    env:
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Clean workspace
        run: |
          echo "üßπ Cleaning workspace..."
          rm -rf allure-reports allure-report-merged
          mkdir -p allure-reports
          echo "‚úÖ Workspace cleaned"

      - name: Download Companies Report
        uses: actions/download-artifact@v4
        with:
          name: companies-report
          path: allure-reports/companies

      - name: Download Workers Report
        uses: actions/download-artifact@v4
        with:
          name: workers-report
          path: allure-reports/workers

      - name: Merge Allure Reports
        run: |
          echo "üîÄ Merging Allure reports..."
          npm install -g allure-commandline --save-dev
          
          # Create merged report directory
          mkdir -p allure-report-merged/data
          
          # Copy data from both reports
          echo "Copying companies data..."
          cp -r allure-reports/companies/data/* allure-report-merged/data/ 2>/dev/null || echo "No companies data"
          
          echo "Copying workers data..."
          cp -r allure-reports/workers/data/* allure-report-merged/data/ 2>/dev/null || echo "No workers data"
          
          # Copy the static files from one report (they're the same)
          echo "Copying static assets..."
          cp -r allure-reports/companies/app.js allure-report-merged/ 2>/dev/null || true
          cp -r allure-reports/companies/styles.css allure-report-merged/ 2>/dev/null || true
          cp -r allure-reports/companies/favicon.ico allure-report-merged/ 2>/dev/null || true
          cp -r allure-reports/companies/index.html allure-report-merged/ 2>/dev/null || true
          cp -r allure-reports/companies/plugins allure-report-merged/ 2>/dev/null || true
          cp -r allure-reports/companies/export allure-report-merged/ 2>/dev/null || true
          cp -r allure-reports/companies/history allure-report-merged/ 2>/dev/null || true
          
          # Regenerate the widgets/summary
          echo "Regenerating report structure..."
          allure generate allure-report-merged/data --clean -o final-report || {
            echo "‚ö†Ô∏è Direct merge failed, using alternative method..."
            # Alternative: just use the companies report as base and copy workers data
            cp -r allure-reports/companies final-report
            cp -r allure-reports/workers/data/* final-report/data/ 2>/dev/null || true
          }
          
          echo "‚úÖ Reports merged successfully!"
          ls -lah final-report/

      - name: Extract Stats from Merged Report
        id: stats
        run: |
          echo "üìä Extracting stats from merged Allure report..."
          
          SUMMARY_FILE="final-report/widgets/summary.json"
          
          if [ -f "$SUMMARY_FILE" ]; then
            TOTAL=$(jq -r '.statistic.total // 0' "$SUMMARY_FILE")
            PASSED=$(jq -r '.statistic.passed // 0' "$SUMMARY_FILE")
            FAILED=$(jq -r '.statistic.failed // 0' "$SUMMARY_FILE")
            BROKEN=$(jq -r '.statistic.broken // 0' "$SUMMARY_FILE")
            SKIPPED=$(jq -r '.statistic.skipped // 0' "$SUMMARY_FILE")
            
            # Combine failed and broken
            TOTAL_FAILED=$((FAILED + BROKEN))
            
            echo "TOTAL=$TOTAL" >> $GITHUB_OUTPUT
            echo "PASSED=$PASSED" >> $GITHUB_OUTPUT
            echo "FAILED=$TOTAL_FAILED" >> $GITHUB_OUTPUT
            echo "SKIPPED=$SKIPPED" >> $GITHUB_OUTPUT
            
            echo "‚úÖ Stats extracted: Total=$TOTAL, Passed=$PASSED, Failed=$TOTAL_FAILED, Skipped=$SKIPPED"
          else
            echo "‚ö†Ô∏è Summary file not found"
            echo "TOTAL=0" >> $GITHUB_OUTPUT
            echo "PASSED=0" >> $GITHUB_OUTPUT
            echo "FAILED=0" >> $GITHUB_OUTPUT
            echo "SKIPPED=0" >> $GITHUB_OUTPUT
          fi

      - name: üåç Deploy Merged Report to Surge
        id: surge_deploy
        if: always()
        continue-on-error: true
        run: |
          npm install --global surge
          
          echo "üöÄ Deploying merged report to Surge..."
          
          # Deploy to production URL
          surge ./final-report https://kwant-ui-automation.surge.sh --token $SURGE_TOKEN
          
          # Generate timestamped URL
          TIMESTAMP_ID=$(date +%s)
          PREVIEW_URL="https://kwant-${TIMESTAMP_ID}.surge.sh"
          
          # Try to deploy to timestamped URL
          surge ./final-report $PREVIEW_URL --token $SURGE_TOKEN || PREVIEW_URL="https://kwant-ui-automation.surge.sh"
          
          # Save the preview URL
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Deployed to: $PREVIEW_URL"

      - name: Send Slack Notification
        if: always()
        run: |
          SURGE_URL=${{ steps.surge_deploy.outputs.preview_url }}
          
          if [ -z "$SURGE_URL" ]; then
            SURGE_URL="https://kwant-ui-automation.surge.sh"
          fi

          TOTAL=${{ steps.stats.outputs.TOTAL }}
          PASSED=${{ steps.stats.outputs.PASSED }}
          FAILED=${{ steps.stats.outputs.FAILED }}
          SKIPPED=${{ steps.stats.outputs.SKIPPED }}

          echo "üìä Sending Slack notification with stats: Total=$TOTAL, Passed=$PASSED, Failed=$FAILED, Skipped=$SKIPPED"

          if [ "$TOTAL" -gt 0 ]; then
            SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($PASSED/$TOTAL)*100}")
          else
            SUCCESS_RATE="0.00"
          fi

          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          if [[ "$TOTAL" -eq 0 ]]; then
            STATUS="‚ö†Ô∏è UI tests did not run properly"
            COLOR="warning"
          elif [[ "$FAILED" -eq 0 ]]; then
            STATUS="‚úÖ UI tests completed successfully"
            COLOR="good"
          elif [[ "$FAILED" -eq 1 ]]; then
            STATUS="üö® $FAILED test failed out of $TOTAL tests in UI"
            COLOR="danger"
          else
            STATUS="üö® $FAILED tests failed out of $TOTAL tests in UI"
            COLOR="danger"
          fi

          PAYLOAD=$(jq -n \
            --arg color "$COLOR" \
            --arg status "$STATUS" \
            --arg total "$TOTAL" \
            --arg passed "$PASSED" \
            --arg failed "$FAILED" \
            --arg skipped "$SKIPPED" \
            --arg success_rate "$SUCCESS_RATE%" \
            --arg timestamp "$TIMESTAMP" \
            --arg preview_url "$SURGE_URL" \
            '{
              attachments: [
                {
                  color: $color,
                  title: $status,
                  fields: [
                    {title: "Total Tests", value: $total, short: true},
                    {title: "‚úÖ Passed", value: $passed, short: true},
                    {title: "‚ùå Failed", value: $failed, short: true},
                    {title: "‚è≠Ô∏è Skipped", value: $skipped, short: true},
                    {title: "üìà Success Rate", value: $success_rate, short: true},
                    {title: "üïê Last Checked", value: $timestamp, short: false}
                  ],
                  actions: [
                    {
                      type: "button",
                      text: "View Detailed Report",
                      url: $preview_url
                    }
                  ]
                }
              ]
            }')

          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            ${{ secrets.SLACK_WEBHOOK_URL }} || echo "Slack notification skipped (invalid webhook)"
