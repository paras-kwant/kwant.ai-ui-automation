name: Run Cypress UI Tests (Parallel Folders)

on:
  workflow_dispatch:
  schedule:
    - cron: "05 04 * * *" # Nepali 10:05 AM

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        folder:
          - cypress/e2e/companies
          - cypress/e2e/workers
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
      TERM: xterm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: ${{ runner.os }}-cypress-binary-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-cypress-binary-

      - name: Install dependencies
        run: npm ci

      - name: Verify Cypress
        run: npx cypress verify

      - name: Clean Allure results
        run: rm -rf allure-results && mkdir -p allure-results

      - name: Run Cypress tests - ${{ matrix.folder }}
        id: cypress
        continue-on-error: true
        run: |
          FOLDER_NAME=$(basename "${{ matrix.folder }}")
          echo "=== Running all tests in ${{ matrix.folder }} folder ==="
          
          npx cypress run \
            --spec "${{ matrix.folder }}/**/*.cy.js" \
            --env email=$EMAIL,password=$PASSWORD \
            --browser chrome \
            --headless \
            --reporter @shelex/cypress-allure-plugin

          CYPRESS_EXIT_CODE=$?

          echo "exit_code=$CYPRESS_EXIT_CODE" >> $GITHUB_OUTPUT
          echo "folder=$FOLDER_NAME" >> $GITHUB_OUTPUT

      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.folder }}
          path: allure-results
          if-no-files-found: ignore
          retention-days: 7

  aggregate:
  needs: cypress-run
  runs-on: ubuntu-latest
  if: always()
  env:
    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
    TERM: xterm

  steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all Allure results
      uses: actions/download-artifact@v4
      with:
        path: all-results
        pattern: allure-results-*

    - name: Merge Allure Results
      id: merge
      run: |
        mkdir -p allure-results
        for folder in all-results/*; do
          if [ -d "$folder" ]; then
            cp -R "$folder"/* allure-results/ 2>/dev/null || true
          fi
        done

        # Generate Allure HTML report
        if [ -d "allure-results" ] && [ "$(ls -A allure-results 2>/dev/null)" ]; then
          npx allure generate allure-results --clean -o allure-report
        else
          mkdir -p allure-report
          echo "<html><body><h1>No test results available</h1></body></html>" > allure-report/index.html
        fi

        # Calculate total test stats from merged Mochawesome JSONs
        mkdir -p cypress/results
        cp all-results/*/cypress/results/*.json cypress/results/ 2>/dev/null || true

        TOTAL=$(jq '[.stats.tests] | add // 0' cypress/results/*.json)
        PASSED=$(jq '[.stats.passes] | add // 0' cypress/results/*.json)
        FAILED=$(jq '[.stats.failures] | add // 0' cypress/results/*.json)
        SKIPPED=$(jq '[.stats.pending] | add // 0' cypress/results/*.json)
        TOTAL_TIME_MS=$(jq '[.stats.duration] | add // 0' cypress/results/*.json)

        if [ "$TOTAL" -gt 0 ]; then
          SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($PASSED/$TOTAL)*100}")
        else
          SUCCESS_RATE="0.00"
        fi

        MINUTES=$((TOTAL_TIME_MS / 60000))
        SECONDS=$(((TOTAL_TIME_MS % 60000) / 1000))
        TOTAL_TIME="${MINUTES}m ${SECONDS}s"

        TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

        echo "total=$TOTAL" >> $GITHUB_OUTPUT
        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        echo "failed=$FAILED" >> $GITHUB_OUTPUT
        echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
        echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
        echo "total_time=$TOTAL_TIME" >> $GITHUB_OUTPUT
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

    - name: Deploy Allure Report to Surge
      id: surge_deploy
      run: |
        npm install --global surge
        surge ./allure-report https://kwant-ui-automation.surge.sh --token $SURGE_TOKEN
        echo "preview_url=https://kwant-ui-automation.surge.sh" >> $GITHUB_OUTPUT

    - name: Send Slack Notification
      run: |
        TOTAL="${{ steps.merge.outputs.total }}"
        PASSED="${{ steps.merge.outputs.passed }}"
        FAILED="${{ steps.merge.outputs.failed }}"
        SKIPPED="${{ steps.merge.outputs.skipped }}"
        SUCCESS_RATE="${{ steps.merge.outputs.success_rate }}"
        TOTAL_TIME="${{ steps.merge.outputs.total_time }}"
        TIMESTAMP="${{ steps.merge.outputs.timestamp }}"
        PREVIEW_URL="${{ steps.surge_deploy.outputs.preview_url }}"

        # Determine status color
        if [ "$TOTAL" -eq 0 ]; then
          STATUS="‚ö†Ô∏è UI tests did not run properly"
          COLOR="warning"
        elif [ "$FAILED" -eq 0 ]; then
          STATUS="‚úÖ All UI tests passed successfully"
          COLOR="good"
        elif [ "$FAILED" -eq 1 ]; then
          STATUS="üö® 1 test failed out of $TOTAL tests"
          COLOR="danger"
        else
          STATUS="üö® $FAILED tests failed out of $TOTAL tests"
          COLOR="danger"
        fi

        PAYLOAD=$(jq -n \
          --arg color "$COLOR" \
          --arg status "$STATUS" \
          --arg total "$TOTAL" \
          --arg passed "$PASSED" \
          --arg failed "$FAILED" \
          --arg skipped "$SKIPPED" \
          --arg success_rate "$SUCCESS_RATE%" \
          --arg total_time "$TOTAL_TIME" \
          --arg timestamp "$TIMESTAMP" \
          --arg report_url "$PREVIEW_URL" \
          '{
            attachments: [
              {
                color: $color,
                title: $status,
                fields: [
                  {title: "Total Tests", value: $total, short: true},
                  {title: "‚úÖ Passed", value: $passed, short: true},
                  {title: "‚ùå Failed", value: $failed, short: true},
                  {title: "‚è≠Ô∏è Skipped", value: $skipped, short: true},
                  {title: "üìà Success Rate", value: $success_rate, short: true},
                  {title: "‚è±Ô∏è Duration", value: $total_time, short: true},
                  {title: "üïê Last Checked", value: $timestamp, short: false}
                ],
                actions: [
                  {
                    type: "button",
                    text: "View Detailed Report",
                    url: $report_url
                  }
                ]
              }
            ]
          }')

        curl -X POST -H 'Content-type: application/json' \
          --data "$PAYLOAD" \
          "$SLACK_WEBHOOK_URL"

