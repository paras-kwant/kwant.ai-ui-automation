name: Run Cypress UI Tests (Parallel Folders)

on:
  workflow_dispatch:
  schedule:
    - cron: "05 04 * * *" # Nepali 10:05 AM

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        folder:
          - cypress/e2e/companies
          - cypress/e2e/workers
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
      TWILIO_NUMBER: ${{ secrets.TWILIO_NUMBER }}
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
      EXPECTED_FROM: ${{ secrets.EXPECTED_FROM }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: ${{ runner.os }}-cypress-binary-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-cypress-binary-

      - name: Install dependencies
        run: npm ci

      - name: Verify Cypress
        run: npx cypress verify

      - name: Clean Allure results
        run: |
          # Remove old allure-results to prevent mixing old and new data
          rm -rf allure-results
          mkdir -p allure-results
          echo "Allure results directory cleaned"

      - name: Run Cypress tests - ${{ matrix.folder }}
        id: cypress
        continue-on-error: true
        run: |
          # Get folder name for display
          FOLDER_NAME=$(basename "${{ matrix.folder }}")
          
          echo "=== Running all tests in ${{ matrix.folder }} folder ==="
          
          # Run all test files in the specified folder
          npx cypress run \
            --spec "${{ matrix.folder }}/**/*.cy.js" \
            --env email=$EMAIL,password=$PASSWORD \
            --browser chrome \
            --headless \
            --reporter mochawesome \
            --reporter-options reportDir=cypress/results,overwrite=false,html=false,json=true
          
          # Store exit code
          CYPRESS_EXIT_CODE=$?
          
          # Ensure results directory exists
          mkdir -p cypress/results
          
          # Check if any JSON reports were generated
          if ! ls cypress/results/mochawesome*.json 1> /dev/null 2>&1; then
            echo "Error: No test reports generated for ${{ matrix.folder }}"
            echo '{"stats":{"tests":0,"passes":0,"failures":0,"pending":0,"duration":0},"results":[]}' > cypress/results/mochawesome-default.json
          fi
          
          # List all generated mochawesome reports for debugging
          echo "Generated mochawesome reports:"
          ls -la cypress/results/mochawesome*.json || echo "No mochawesome JSON files found"
          
          # Merge all mochawesome JSON reports into one for this folder
          npx mochawesome-merge "cypress/results/mochawesome*.json" > cypress/results/merged-report-${FOLDER_NAME}.json
          
          # Validate merged report
          if [ ! -s cypress/results/merged-report-${FOLDER_NAME}.json ]; then
            echo "Warning: Merged report is empty"
            echo '{"stats":{"tests":0,"passes":0,"failures":0,"pending":0,"duration":0},"results":[]}' > cypress/results/merged-report-${FOLDER_NAME}.json
          fi
          
          # Extract stats from merged report
          TOTAL=$(jq -r '.stats.tests // 0' cypress/results/merged-report-${FOLDER_NAME}.json)
          PASSED=$(jq -r '.stats.passes // 0' cypress/results/merged-report-${FOLDER_NAME}.json)
          FAILED=$(jq -r '.stats.failures // 0' cypress/results/merged-report-${FOLDER_NAME}.json)
          SKIPPED=$(jq -r '.stats.pending // 0' cypress/results/merged-report-${FOLDER_NAME}.json)
          TOTAL_TIME_MS=$(jq -r '.stats.duration // 0' cypress/results/merged-report-${FOLDER_NAME}.json)
          
          # Calculate success rate
          if [ "$TOTAL" -gt 0 ]; then
            SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($PASSED/$TOTAL)*100}")
          else
            SUCCESS_RATE="0.00"
          fi
          
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          # Convert milliseconds to minutes and seconds
          MINUTES=$((TOTAL_TIME_MS / 60000))
          SECONDS=$(((TOTAL_TIME_MS % 60000) / 1000))
          TOTAL_TIME="${MINUTES}m ${SECONDS}s"

          # Set outputs
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "total_time=$TOTAL_TIME" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "exit_code=$CYPRESS_EXIT_CODE" >> $GITHUB_OUTPUT
          echo "folder=$FOLDER_NAME" >> $GITHUB_OUTPUT
          
          # Debug output
          echo "=== TEST EXECUTION SUMMARY ==="
          echo "Folder: $FOLDER_NAME"
          echo "Total: $TOTAL | Passed: $PASSED | Failed: $FAILED | Skipped: $SKIPPED"
          echo "Duration: $TOTAL_TIME | Success Rate: $SUCCESS_RATE%"
          echo "Exit Code: $CYPRESS_EXIT_CODE"
          echo "============================="
          
          # Exit with Cypress exit code
          exit $CYPRESS_EXIT_CODE

      - name: Upload Allure Results (raw data only)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ strategy.job-index }}
          path: allure-results
          if-no-files-found: ignore

      - name: Upload Cypress Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots-${{ strategy.job-index }}
          path: cypress/screenshots
          if-no-files-found: ignore

      - name: Upload Cypress Videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos-${{ strategy.job-index }}
          path: cypress/videos
          if-no-files-found: ignore

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ strategy.job-index }}
          path: |
            cypress/results/merged-report-*.json
          if-no-files-found: ignore

  # Aggregate results and send notification
  report:
    needs: cypress-run
    runs-on: ubuntu-latest
    if: always()
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: all-results
          pattern: test-results-*

      - name: Download all Allure results
        uses: actions/download-artifact@v4
        with:
          path: all-allure-results
          pattern: allure-results-*

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install -g mochawesome-merge mochawesome-report-generator allure-commandline

      - name: Merge all test reports
        id: aggregate
        run: |
          # Create results directory
          mkdir -p cypress/results
          
          # Debug: Show what we downloaded
          echo "=== Downloaded artifacts structure ==="
          find all-results -type f -name "*.json"
          echo "===================================="
          
          # Find and copy ALL merged report JSON files from both folders
          find all-results -type f -name "merged-report-*.json" -exec cp {} cypress/results/ \;
          
          # Debug: Show what we're about to merge
          echo "=== Merged reports from parallel jobs ==="
          ls -la cypress/results/merged-report-*.json 2>/dev/null || echo "No merged reports found"
          echo "=========================================="
          
          # Check if we have any merged reports
          if ls cypress/results/merged-report-*.json 1> /dev/null 2>&1; then
            # Show each report's stats before final merge
            for file in cypress/results/merged-report-*.json; do
              echo "=== Stats from $file ==="
              jq '.stats' "$file" 2>/dev/null || echo "Could not read stats"
              echo "======================="
            done
            
            echo "Attempting to merge all folder reports..."
            if npx mochawesome-merge "cypress/results/merged-report-*.json" > cypress/results/final-report.json; then
              echo "‚úì Successfully merged all folder reports"
            else
              echo "‚úó Mochawesome-merge failed, creating manual aggregate..."
              # Manual aggregation fallback
              jq -s '{
                stats: {
                  suites: ([.[].stats.suites // 0] | add),
                  tests: ([.[].stats.tests // 0] | add),
                  passes: ([.[].stats.passes // 0] | add),
                  pending: ([.[].stats.pending // 0] | add),
                  failures: ([.[].stats.failures // 0] | add),
                  start: (.[0].stats.start // ""),
                  end: (.[-1].stats.end // ""),
                  duration: ([.[].stats.duration // 0] | add),
                  testsRegistered: ([.[].stats.testsRegistered // 0] | add),
                  passPercent: (([.[].stats.passes // 0] | add) / ([.[].stats.tests // 1] | add) * 100),
                  pendingPercent: (([.[].stats.pending // 0] | add) / ([.[].stats.tests // 1] | add) * 100)
                },
                results: ([.[].results // []] | add)
              }' cypress/results/merged-report-*.json > cypress/results/final-report.json
            fi
          else
            echo "No merged test reports found"
            echo '{"stats":{"tests":0,"passes":0,"failures":0,"pending":0,"duration":0},"results":[]}' > cypress/results/final-report.json
          fi
          
          # Show final aggregated report for debugging
          echo "=== FINAL AGGREGATED REPORT STATS ==="
          jq '.stats' cypress/results/final-report.json 2>/dev/null || echo "Error reading final report"
          echo "====================================="
          
          # Extract aggregated stats from final report
          TOTAL=$(jq -r '.stats.tests // 0' cypress/results/final-report.json)
          PASSED=$(jq -r '.stats.passes // 0' cypress/results/final-report.json)
          FAILED=$(jq -r '.stats.failures // 0' cypress/results/final-report.json)
          SKIPPED=$(jq -r '.stats.pending // 0' cypress/results/final-report.json)
          TOTAL_TIME_MS=$(jq -r '.stats.duration // 0' cypress/results/final-report.json)
          
          # Calculate success rate
          if [ "$TOTAL" -gt 0 ]; then
            SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($PASSED/$TOTAL)*100}")
          else
            SUCCESS_RATE="0.00"
          fi
          
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          # Convert milliseconds to minutes and seconds
          MINUTES=$((TOTAL_TIME_MS / 60000))
          SECONDS=$(((TOTAL_TIME_MS % 60000) / 1000))
          TOTAL_TIME="${MINUTES}m ${SECONDS}s"
          
          # Set outputs
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "total_time=$TOTAL_TIME" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          echo "=== FINAL AGGREGATED RESULTS ==="
          echo "Total: $TOTAL | Passed: $PASSED | Failed: $FAILED"
          echo "Success Rate: $SUCCESS_RATE% | Duration: $TOTAL_TIME"
          echo "================================"

      - name: Generate combined Allure Report
        run: |
          # Clean and create fresh allure-results directory
          rm -rf allure-results allure-report
          mkdir -p allure-results
          
          echo "=== Merging Allure results from parallel runs ==="
          # Copy all allure results from both parallel jobs
          find all-allure-results -type f -exec cp {} allure-results/ \; 2>/dev/null || true
          
          # Check what we collected
          echo "Allure results files count: $(ls allure-results/ 2>/dev/null | wc -l)"
          
          # Generate report only from current run's data
          if [ -d "allure-results" ] && [ "$(ls -A allure-results 2>/dev/null)" ]; then
            echo "Generating fresh Allure report from current run only..."
            npx allure generate allure-results --clean -o allure-report
            echo "‚úì Allure report generated successfully"
          else
            echo "‚ö† No Allure results found, creating placeholder report"
            mkdir -p allure-report
            echo "<html><body><h1>No test results available for this run</h1></body></html>" > allure-report/index.html
          fi

      - name: Deploy Allure Report to Surge
        id: surge_deploy
        continue-on-error: true
        run: |
          npm install --global surge
          
          echo "Deploying fresh Allure report to Surge..."
          # Deploy to production URL
          surge ./allure-report https://kwant-ui-automation.surge.sh --token $SURGE_TOKEN
          
          echo "preview_url=https://kwant-ui-automation.surge.sh" >> $GITHUB_OUTPUT
          echo "‚úì Deployed to: https://kwant-ui-automation.surge.sh"

      - name: Send Slack Notification
        run: |
          TOTAL="${{ steps.aggregate.outputs.total }}"
          PASSED="${{ steps.aggregate.outputs.passed }}"
          FAILED="${{ steps.aggregate.outputs.failed }}"
          SKIPPED="${{ steps.aggregate.outputs.skipped }}"
          SUCCESS_RATE="${{ steps.aggregate.outputs.success_rate }}"
          TOTAL_TIME="${{ steps.aggregate.outputs.total_time }}"
          TIMESTAMP="${{ steps.aggregate.outputs.timestamp }}"
          PREVIEW_URL="${{ steps.surge_deploy.outputs.preview_url }}"

          # Set defaults
          TOTAL="${TOTAL:-0}"
          PASSED="${PASSED:-0}"
          FAILED="${FAILED:-0}"
          SKIPPED="${SKIPPED:-0}"
          SUCCESS_RATE="${SUCCESS_RATE:-0.00}"
          TOTAL_TIME="${TOTAL_TIME:-0m 0s}"
          TIMESTAMP="${TIMESTAMP:-$(date -u '+%Y-%m-%d %H:%M:%S UTC')}"
          PREVIEW_URL="${PREVIEW_URL:-https://kwant-ui-automation.surge.sh}"

          # Determine status
          if [[ "$TOTAL" -eq 0 ]]; then
            STATUS="‚ö†Ô∏è UI tests did not run properly"
            COLOR="warning"
          elif [[ "$FAILED" -eq 0 ]]; then
            STATUS="‚úÖ All UI tests passed successfully"
            COLOR="good"
          elif [[ "$FAILED" -eq 1 ]]; then
            STATUS="üö® 1 test failed out of $TOTAL tests"
            COLOR="danger"
          else
            STATUS="üö® $FAILED tests failed out of $TOTAL tests"
            COLOR="danger"
          fi

          PAYLOAD=$(jq -n \
            --arg color "$COLOR" \
            --arg status "$STATUS" \
            --arg total "$TOTAL" \
            --arg passed "$PASSED" \
            --arg failed "$FAILED" \
            --arg skipped "$SKIPPED" \
            --arg success_rate "$SUCCESS_RATE%" \
            --arg total_time "$TOTAL_TIME" \
            --arg timestamp "$TIMESTAMP" \
            --arg report_url "$PREVIEW_URL" \
            --arg workflow_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            '{
              attachments: [
                {
                  color: $color,
                  title: $status,
                  title_link: $workflow_url,
                  text: "üîÑ Parallel execution: Companies & Workers modules",
                  fields: [
                    {title: "üìä Total Tests", value: $total, short: true},
                    {title: "‚úÖ Passed", value: $passed, short: true},
                    {title: "‚ùå Failed", value: $failed, short: true},
                    {title: "‚è≠Ô∏è Skipped", value: $skipped, short: true},
                    {title: "üìà Success Rate", value: $success_rate, short: true},
                    {title: "‚è±Ô∏è Duration", value: $total_time, short: true},
                    {title: "üïê Timestamp", value: $timestamp, short: false},
                    {title: "üîó Report", value: ("<" + $report_url + "|View Full Report>"), short: false}
                  ],
                  footer: "Kwant UI Automation",
                  footer_icon: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                  ts: now
                }
              ]
            }')

          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL"