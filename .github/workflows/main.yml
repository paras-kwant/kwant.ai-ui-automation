name: Run Cypress Tests

on:
  workflow_dispatch:
  schedule:
    # Nepali 10:02 AM ‚Üí UTC 04:17 AM
    - cron: "17 4 * * *"

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Run Cypress tests
        id: cypress
        continue-on-error: true
        run: |
          mkdir -p cypress/results
          npx cypress run --env email=$EMAIL,password=$PASSWORD \
            --reporter mochawesome \
            --reporter-options reportDir=cypress/results,overwrite=true,html=false,json=true
          
          TOTAL=$(jq '[.results[].suites[].tests[]] | length' cypress/results/mochawesome.json)
          PASSED=$(jq '[.results[].suites[].tests[] | select(.state=="passed")] | length' cypress/results/mochawesome.json)
          FAILED=$(jq '[.results[].suites[].tests[] | select(.state=="failed")] | length' cypress/results/mochawesome.json)
          SKIPPED=$(jq '[.results[].suites[].tests[] | select(.state=="pending")] | length' cypress/results/mochawesome.json)
          SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($PASSED/$TOTAL)*100}")
          TOTAL_TIME=$(jq '[.results[].stats.duration] | add/1000' cypress/results/mochawesome.json)
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "total_time=${TOTAL_TIME}s" >> $GITHUB_OUTPUT
          echo "tests_ran=$([[ $TOTAL -gt 0 ]] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

      - name: Generate Allure Report
        run: |
          npx allure generate allure-results --clean -o allure-report

      - name: Deploy Allure Report to Surge
        run: |
          npm install --global surge
          surge ./allure-report https://kwant-automation-dashboard.surge.sh --token $SURGE_TOKEN

      - name: Send Slack Notification
        if: always()
        run: |
          TOTAL="${{ steps.cypress.outputs.total }}"
          PASSED="${{ steps.cypress.outputs.passed }}"
          FAILED="${{ steps.cypress.outputs.failed }}"
          SKIPPED="${{ steps.cypress.outputs.skipped }}"
          SUCCESS_RATE="${{ steps.cypress.outputs.success_rate }}"
          TOTAL_TIME="${{ steps.cypress.outputs.total_time }}"
          TESTS_RAN="${{ steps.cypress.outputs.tests_ran }}"
          TIME="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          if [[ "$TESTS_RAN" == "false" ]]; then
            STATUS="‚ö†Ô∏è PROD test automation didn't run properly"
            COLOR="warning"
          elif [[ "$FAILED" -eq 0 ]]; then
            STATUS="‚úÖ PROD test automation completed successfully"
            COLOR="good"
          else
            STATUS="üö® PROD test automation failed"
            COLOR="danger"
          fi

          PAYLOAD="{
            \"attachments\": [
              {
                \"color\": \"$COLOR\",
                \"title\": \"$STATUS\",
                \"fields\": [
                  {\"title\": \"Total Tests\", \"value\": \"$TOTAL\", \"short\": true},
                  {\"title\": \"‚úÖ Passed\", \"value\": \"$PASSED\", \"short\": true},
                  {\"title\": \"‚ùå Failed\", \"value\": \"$FAILED\", \"short\": true},
                  {\"title\": \"‚è≠Ô∏è Skipped\", \"value\": \"$SKIPPED\", \"short\": true},
                  {\"title\": \"üìà Success Rate\", \"value\": \"$SUCCESS_RATE%\", \"short\": true},
                  {\"title\": \"‚è≥ Total Time\", \"value\": \"$TOTAL_TIME\", \"short\": true},
                  {\"title\": \"üïê Last Checked\", \"value\": \"$TIME\", \"short\": false}
                ],
                \"actions\": [
                  {
                    \"type\": \"button\",
                    \"text\": \"View Detailed Report\",
                    \"url\": \"https://kwant-automation-dashboard.surge.sh/\"
                  }
                ]
              }
            ]
          }"

          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL"
