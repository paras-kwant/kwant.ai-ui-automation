name: Run Cypress Tests

on:
  schedule:
    - cron: "15 4 * * *" 
  workflow_dispatch:

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Clean old Allure results
        run: rm -rf allure-results allure-report

      - name: Run Cypress tests and capture results
        id: cypress
        continue-on-error: true
        run: |
          npx cypress run --env email=$EMAIL,password=$PASSWORD \
            --reporter spec \
            | sed 's/\x1b\[[0-9;]*m//g' \
            | tee cypress_output.txt

          SUMMARY_LINE=$(grep -A1 "‚îî‚îÄ*" cypress_output.txt | tail -n 1)
          
          TOTAL=0
          PASSED=0
          FAILED=0
          PENDING=0
          SKIPPED=0
          TOTAL_TIME="0:00"
          SUCCESS_RATE=0

          if [[ ! -z "$SUMMARY_LINE" ]]; then
            TOTAL=$(echo "$SUMMARY_LINE" | awk '{gsub(/-/, "0", $(NF-4)); print $(NF-4)}')
            PASSED=$(echo "$SUMMARY_LINE" | awk '{gsub(/-/, "0", $(NF-3)); print $(NF-3)}')
            FAILED=$(echo "$SUMMARY_LINE" | awk '{gsub(/-/, "0", $(NF-2)); print $(NF-2)}')
            PENDING=$(echo "$SUMMARY_LINE" | awk '{gsub(/-/, "0", $(NF-1)); print $(NF-1)}')
            SKIPPED=$(echo "$SUMMARY_LINE" | awk '{gsub(/-/, "0", $NF); print $NF}')
            TOTAL_TIME=$(echo "$SUMMARY_LINE" | grep -oE '[0-9]+:[0-9]+' || echo "0:00")
            
            if [[ $TOTAL -gt 0 ]]; then
              SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($PASSED/$TOTAL) * 100}")
            fi
          fi

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "total_time=$TOTAL_TIME" >> $GITHUB_OUTPUT
          echo "tests_ran=$([[ $TOTAL -gt 0 ]] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

      - name: Clean Allure retry results
        if: always()
        run: node scripts/clean-allure-retries.js

      - name: Generate Allure Report
        if: always()
        run: npx allure generate allure-results --clean -o allure-report

      - name: Deploy to Surge
        if: always()
        run: |
          npx surge ./allure-report https://kwant-ui-automation-dashboard.surge.sh --token $SURGE_TOKEN

      - name: Check for timeout
        id: check_timeout
        if: always()
        run: |
          if [[ "${{ job.status }}" == "failure" || "${{ job.status }}" == "cancelled" ]]; then
            echo "timeout=true" >> $GITHUB_OUTPUT
          else
            echo "timeout=false" >> $GITHUB_OUTPUT
          fi

      - name: Send notification to Slack
        if: always()
        run: |
          TESTS_RAN="${{ steps.cypress.outputs.tests_ran }}"
          TIMEOUT="${{ steps.check_timeout.outputs.timeout }}"
          FAILED_COUNT="${{ steps.cypress.outputs.failed }}"
          TOTAL_COUNT="${{ steps.cypress.outputs.total }}"
          TIME="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          ALLURE_REPORT_URL="https://kwant-ui-automation-dashboard.surge.sh"

          if [[ "$TIMEOUT" == "true" ]]; then
            STATUS="‚è±Ô∏è UAT test automation (exceeded 15 minutes)"
            COLOR="danger"
            TOTAL_TIME_VALUE="Exceeded 15 minutes"
          elif [[ "$TESTS_RAN" == "false" ]]; then
            STATUS="‚ö†Ô∏è UAT test automation didn't run properly"
            COLOR="warning"
            TOTAL_TIME_VALUE="N/A"
          elif [[ "$FAILED_COUNT" -eq 0 && "$TOTAL_COUNT" -gt 0 ]]; then
            STATUS="‚úÖ UAT test automation completed successfully"
            COLOR="good"
            TOTAL_TIME_VALUE="${{ steps.cypress.outputs.total_time }}"
          else
            STATUS="üö® UAT test automation- Health Check tests failed"
            COLOR="danger"
            TOTAL_TIME_VALUE="${{ steps.cypress.outputs.total_time }}"
          fi

          PAYLOAD="{
            \"attachments\": [
              {
                \"color\": \"$COLOR\",
                \"title\": \"$STATUS\",
                \"fields\": [
                  {\"title\": \"Total Tests\", \"value\": \"${{ steps.cypress.outputs.total || '0' }}\", \"short\": true},
                  {\"title\": \"‚úÖ Passed\", \"value\": \"${{ steps.cypress.outputs.passed || '0' }}\", \"short\": true},
                  {\"title\": \"‚ùå Failed\", \"value\": \"${{ steps.cypress.outputs.failed || '0' }}\", \"short\": true},
                  {\"title\": \"‚è≠Ô∏è Skipped\", \"value\": \"${{ steps.cypress.outputs.skipped || '0' }}\", \"short\": true},
                  {\"title\": \"üìà Success Rate\", \"value\": \"${{ steps.cypress.outputs.success_rate || '0' }}%\", \"short\": true},
                  {\"title\": \"‚è≥ Total Time\", \"value\": \"$TOTAL_TIME_VALUE\", \"short\": true},
                  {\"title\": \"üïê Last Checked\", \"value\": \"$TIME\", \"short\": false}
                ],
                \"actions\": [
                  {
                    \"type\": \"button\",
                    \"text\": \"üìä View Allure Report\",
                    \"url\": \"$ALLURE_REPORT_URL\",
                    \"style\": \"primary\"
                  },
                  {
                    \"type\": \"button\",
                    \"text\": \"üîç View GitHub Logs\",
                    \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                  }
                ]
              }
            ]
          }"

          curl -X POST -H 'Content-type: application/json' \
          --data "$PAYLOAD" \
          $SLACK_WEBHOOK_URL