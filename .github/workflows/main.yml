name: Run Cypress Tests

on:
  schedule:
    - cron: "17 4 * * *" 
  workflow_dispatch:

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run Cypress tests and capture results
        id: cypress
        continue-on-error: true
        run: |
          # Run Cypress
          npx cypress run --env email=$EMAIL,password=$PASSWORD --reporter spec | tee cypress_output.txt

          # Determine if tests ran
          if [ ${PIPESTATUS[0]} -ge 0 ]; then
            echo "tests_ran=true" >> $GITHUB_OUTPUT
          else
            echo "tests_ran=false" >> $GITHUB_OUTPUT
          fi

          # Extract test summary
          PASSED=$(grep -oE '([0-9]+) passing' cypress_output.txt | awk '{print $1}' || echo 0)
          FAILED=$(grep -oE '([0-9]+) failing' cypress_output.txt | awk '{print $1}' || echo 0)
          SKIPPED=0
          TOTAL=$((PASSED+FAILED))
          SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($PASSED/($TOTAL))*100}")
          TOTAL_TIME=$(grep -oE '[0-9]+m[0-9]+s' cypress_output.txt | tail -1 || echo "0:00")

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "total_time=$TOTAL_TIME" >> $GITHUB_OUTPUT

      - name: Generate Allure Report
        run: |
          npx allure generate allure-results --clean -o allure-report

      - name: Deploy Allure Report to Surge
        if: always()
        run: |
          npm install --global surge
          surge ./allure-report https://kwant-automation-dashboard.surge.sh --token $SURGE_TOKEN

      - name: Send notification to Slack
        if: always()
        run: |
          TESTS_RAN="${{ steps.cypress.outputs.tests_ran }}"
          TOTAL="${{ steps.cypress.outputs.total }}"
          PASSED="${{ steps.cypress.outputs.passed }}"
          FAILED="${{ steps.cypress.outputs.failed }}"
          SKIPPED="${{ steps.cypress.outputs.skipped }}"
          SUCCESS_RATE="${{ steps.cypress.outputs.success_rate }}"
          TOTAL_TIME="${{ steps.cypress.outputs.total_time }}"
          TIME="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          if [[ "$TESTS_RAN" != "true" ]]; then
            STATUS="‚ö†Ô∏è UAT test automation didn't run properly"
            COLOR="warning"
          elif [[ "$FAILED" -eq 0 && "$TOTAL" -gt 0 ]]; then
            STATUS="‚úÖ UAT test automation completed successfully"
            COLOR="good"
          else
            STATUS="üö® UAT test automation- Health Check tests failed"
            COLOR="danger"
          fi

          # Slack payload
          PAYLOAD=$(jq -n \
            --arg color "$COLOR" \
            --arg status "$STATUS" \
            --arg total "$TOTAL" \
            --arg passed "$PASSED" \
            --arg failed "$FAILED" \
            --arg skipped "$SKIPPED" \
            --arg success_rate "$SUCCESS_RATE%" \
            --arg total_time "$TOTAL_TIME" \
            --arg timestamp "$TIME" \
            --arg report_url "https://kwant-automation-dashboard.surge.sh/" \
            '{
              attachments: [
                {
                  color: $color,
                  title: $status,
                  fields: [
                    {title: "Total Tests", value: $total, short: true},
                    {title: "‚úÖ Passed", value: $passed, short: true},
                    {title: "‚ùå Failed", value: $failed, short: true},
                    {title: "‚è≠Ô∏è Skipped", value: $skipped, short: true},
                    {title: "üìà Success Rate", value: $success_rate, short: true},
                    {title: "‚è≥ Total Time", value: $total_time, short: true},
                    {title: "üïê Last Checked", value: $timestamp, short: false}
                  ],
                  actions: [
                    {
                      type: "button",
                      text: "View Detailed Report",
                      url: $report_url
                    }
                  ]
                }
              ]
            }')

          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL"
